<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Task Reminder App - Smart scheduling and text-based task editing" />
    <title>Task Reminder App</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

      :root {
        --background: 210 11% 98%;
        --foreground: 210 11% 15%;
        --primary: 217 91% 60%;
        --secondary: 215 16% 47%;
        --success: 142 76% 36%;
        --warning: 38 92% 50%;
        --danger: 0 84% 60%;
        --border: 210 11% 90%;
        --input: 210 11% 96%;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: hsl(var(--background));
        color: hsl(var(--foreground));
        line-height: 1.6;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        text-decoration: none;
        gap: 0.5rem;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-primary {
        background-color: hsl(var(--primary));
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background-color: hsl(var(--primary) / 0.9);
      }

      .btn-success {
        background-color: hsl(var(--success));
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        background-color: hsl(var(--success) / 0.9);
      }

      .btn-warning {
        background-color: hsl(var(--warning));
        color: white;
      }

      .btn-warning:hover:not(:disabled) {
        background-color: hsl(var(--warning) / 0.9);
      }

      .card {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid hsl(var(--border));
        padding: 1.5rem;
        box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      }

      .input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid hsl(var(--border));
        border-radius: 0.5rem;
        background-color: hsl(var(--input));
        font-size: 0.875rem;
        transition: border-color 0.2s ease-in-out;
      }

      .input:focus {
        outline: none;
        border-color: hsl(var(--primary));
        box-shadow: 0 0 0 3px hsl(var(--primary) / 0.1);
      }

      .textarea {
        min-height: 150px;
        resize: vertical;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        line-height: 1.5;
      }

      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
      }

      .popup-content {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
      }

      .toggle {
        position: relative;
        display: inline-block;
        width: 44px;
        height: 24px;
      }

      .toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: hsl(var(--secondary) / 0.3);
        transition: 0.4s;
        border-radius: 24px;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .toggle input:checked + .toggle-slider {
        background-color: hsl(var(--primary));
      }

      .toggle input:checked + .toggle-slider:before {
        transform: translateX(20px);
      }
    </style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    
    <script type="text/babel">
      const { useState, useEffect } = React;

      // Task Editor Component
      const TaskEditor = ({ tasks, onSave, onClose }) => {
        const [rawText, setRawText] = useState('');

        useEffect(() => {
          const taskLines = tasks.map(task => {
            if (task.type === 'timed') {
              return `${task.time} ${task.description}`;
            } else {
              return task.description;
            }
          });
          setRawText(taskLines.join('\n'));
        }, [tasks]);

        const handleSave = () => {
          onSave(rawText);
          onClose();
        };

        const formatExample = `Example format:
09:00 drink water
15:30 check emails
read 15 minutes
exercise
call mom`;

        return (
          <div className="popup-overlay">
            <div className="popup-content">
              <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold">‚úèÔ∏è Edit Tasks</h2>
                <button 
                  className="text-gray-500 hover:text-gray-700 text-2xl"
                  onClick={onClose}
                >
                  √ó
                </button>
              </div>

              <div className="mb-4">
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                  <h3 className="font-semibold text-blue-900 mb-2">üìù Task Format:</h3>
                  <div className="text-sm text-blue-800 space-y-1">
                    <div><strong>Timed tasks:</strong> HH:MM description (e.g., "09:00 drink water")</div>
                    <div><strong>General tasks:</strong> Just description (e.g., "read 15 minutes")</div>
                  </div>
                </div>

                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Tasks (one per line):
                </label>
                <textarea
                  className="input textarea"
                  value={rawText}
                  onChange={(e) => setRawText(e.target.value)}
                  placeholder={formatExample}
                  rows={12}
                />
                <div className="text-xs text-gray-500 mt-2">
                  General tasks reset daily. Completed status is tracked per day.
                </div>
              </div>

              <div className="flex gap-3">
                <button className="btn btn-primary flex-1" onClick={handleSave}>
                  üíæ Save Tasks
                </button>
                <button className="btn btn-secondary bg-gray-500 text-white" onClick={onClose}>
                  Cancel
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Working Mode Component
      const WorkingMode = ({ workingMode, onToggle }) => {
        const isActive = workingMode.active && workingMode.until && new Date(workingMode.until) > new Date();
        
        const getTimeUntil = () => {
          if (!workingMode.until) return '';
          const until = new Date(workingMode.until);
          const now = new Date();
          
          if (until <= now) return '';
          
          return until.toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        };

        const handleToggle = () => {
          onToggle(!isActive);
        };

        return (
          <div className="flex items-center gap-3">
            <div className="flex items-center gap-2">
              <label className="toggle">
                <input 
                  type="checkbox" 
                  checked={isActive}
                  onChange={handleToggle}
                />
                <span className="toggle-slider"></span>
              </label>
              <span className="text-sm font-medium">
                üîß Working Mode
              </span>
            </div>
            
            {isActive && (
              <div className="text-xs text-orange-600 font-medium">
                Active until {getTimeUntil()}
              </div>
            )}
          </div>
        );
      };

      // Reminder Popup Component
      const ReminderPopup = ({ reminderData, onComplete, onSnooze, onClose }) => {
        const { currentTimedTasks, incompleteGeneralTasks } = reminderData;
        const hasTasksToShow = currentTimedTasks.length > 0 || incompleteGeneralTasks.length > 0;

        if (!hasTasksToShow) {
          return null;
        }

        return (
          <div className="popup-overlay">
            <div className="popup-content">
              <div className="text-center mb-6">
                <div className="text-4xl mb-2">‚è∞</div>
                <h2 className="text-2xl font-bold text-gray-900">Task Reminder</h2>
                <div className="text-sm text-gray-600 mt-1">
                  {new Date().toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  })}
                </div>
              </div>

              <div className="space-y-4 mb-6">
                {currentTimedTasks.length > 0 && (
                  <div>
                    <h3 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                      üéØ Current Tasks
                    </h3>
                    <div className="space-y-2">
                      {currentTimedTasks.map(task => (
                        <div key={task.id} className="bg-red-50 border border-red-200 rounded-lg p-3">
                          <div className="flex items-center gap-2">
                            <span className="font-mono font-semibold text-red-700">{task.time}</span>
                            <span className="text-gray-900">{task.description}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {incompleteGeneralTasks.length > 0 && (
                  <div>
                    <h3 className="font-semibold text-gray-900 mb-3 flex items-center gap-2">
                      üìã Pending Tasks
                    </h3>
                    <div className="space-y-2">
                      {incompleteGeneralTasks.map(task => (
                        <div key={task.id} className="bg-orange-50 border border-orange-200 rounded-lg p-3">
                          <span className="text-gray-900">{task.description}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              <div className="flex gap-3">
                <button 
                  className="btn btn-success flex-1"
                  onClick={onComplete}
                >
                  ‚úÖ Mark Completed
                </button>
                <button 
                  className="btn btn-warning flex-1"
                  onClick={onSnooze}
                >
                  üîÅ Snooze 5min
                </button>
              </div>

              <button 
                className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl"
                onClick={onClose}
              >
                √ó
              </button>

              <div className="mt-4 text-xs text-gray-500 text-center">
                Completing will mark all pending general tasks as done
              </div>
            </div>
          </div>
        );
      };

      // Confetti animation function
      const createConfetti = () => {
        const confettiContainer = document.createElement('div');
        confettiContainer.style.position = 'fixed';
        confettiContainer.style.top = '0';
        confettiContainer.style.left = '0';
        confettiContainer.style.width = '100%';
        confettiContainer.style.height = '100%';
        confettiContainer.style.pointerEvents = 'none';
        confettiContainer.style.zIndex = '9999';
        document.body.appendChild(confettiContainer);

        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8'];
        
        for (let i = 0; i < 50; i++) {
          const confetti = document.createElement('div');
          confetti.style.position = 'absolute';
          confetti.style.width = '10px';
          confetti.style.height = '10px';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.top = '-10px';
          confetti.style.borderRadius = '50%';
          confetti.style.animation = `confetti-fall ${2 + Math.random() * 3}s linear forwards`;
          confettiContainer.appendChild(confetti);
        }

        // Add CSS animation
        if (!document.getElementById('confetti-styles')) {
          const style = document.createElement('style');
          style.id = 'confetti-styles';
          style.textContent = `
            @keyframes confetti-fall {
              to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
              }
            }
          `;
          document.head.appendChild(style);
        }

        setTimeout(() => {
          document.body.removeChild(confettiContainer);
        }, 5000);
      };

      // Main App Component
      const App = () => {
        const [tasks, setTasks] = useState([]);
        const [completedTasks, setCompletedTasks] = useState([]);
        const [workingMode, setWorkingMode] = useState({ active: false, until: null });
        const [showEditor, setShowEditor] = useState(false);
        const [showReminder, setShowReminder] = useState(false);
        const [reminderData, setReminderData] = useState(null);
        const [currentTime, setCurrentTime] = useState(new Date());
        const [coins, setCoins] = useState(0);

        // Update current time every minute
        useEffect(() => {
          const timer = setInterval(() => {
            setCurrentTime(new Date());
          }, 60000);
          return () => clearInterval(timer);
        }, []);

        // Load initial data
        useEffect(() => {
          loadInitialData();
          // Load coins from localStorage
          const savedCoins = localStorage.getItem('task_reminder_coins');
          if (savedCoins) {
            setCoins(parseInt(savedCoins, 10));
          }
        }, []);

        const loadInitialData = async () => {
          try {
            const response = await fetch('/api/tasks');
            const data = await response.json();
            setTasks(data.tasks);
            setCompletedTasks(data.completedGeneralTasks);
            
            if (data.workingModeUntil) {
              const until = new Date(data.workingModeUntil);
              setWorkingMode({
                active: until > new Date(),
                until: until
              });
            }
          } catch (error) {
            console.error('Failed to load tasks:', error);
          }
        };

        const handleTasksSave = async (rawTasks) => {
          try {
            await fetch('/api/tasks', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ tasksRaw: rawTasks })
            });
            
            loadInitialData();
          } catch (error) {
            console.error('Failed to save tasks:', error);
          }
        };

        const handleTaskComplete = async (taskId) => {
          try {
            await fetch('/api/complete-task', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ taskId })
            });
            
            setCompletedTasks(prev => [...prev, taskId]);
            
            // Add coin and show confetti
            const newCoins = coins + 1;
            setCoins(newCoins);
            localStorage.setItem('task_reminder_coins', newCoins.toString());
            createConfetti();
          } catch (error) {
            console.error('Failed to complete task:', error);
          }
        };

        const isTaskCompleted = (taskId) => {
          return completedTasks.includes(taskId);
        };

        const handleWorkingModeToggle = async (enabled) => {
          try {
            const response = await fetch('/api/working-mode', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enabled })
            });
            
            const data = await response.json();
            
            if (data.workingModeUntil) {
              const until = new Date(data.workingModeUntil);
              setWorkingMode({ active: true, until });
            } else {
              setWorkingMode({ active: false, until: null });
            }
          } catch (error) {
            console.error('Failed to toggle working mode:', error);
          }
        };

        const getCurrentTimeFormatted = () => {
          return currentTime.toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
          });
        };

        const getTimedTasksForCurrentTime = () => {
          const currentTimeStr = getCurrentTimeFormatted();
          return tasks.filter(task => task.type === 'timed' && task.time === currentTimeStr);
        };

        const getIncompleteGeneralTasks = () => {
          return tasks.filter(task => 
            task.type === 'general' && !completedTasks.includes(task.id)
          );
        };

        const timedTasks = tasks.filter(task => task.type === 'timed');
        const generalTasks = tasks.filter(task => task.type === 'general');

        return (
          <div className="min-h-screen bg-gray-50">
            <div className="max-w-4xl mx-auto p-4">
              <header className="py-6 border-b border-gray-200 mb-6">
                <div className="flex items-center justify-between mb-2">
                  <h1 className="text-3xl font-bold text-gray-900">ü™ô {coins} coins</h1>
                  <div className="text-sm text-gray-600">
                    Current time: <span className="font-mono font-semibold">{getCurrentTimeFormatted()}</span>
                  </div>
                </div>
                <div className="flex items-center justify-between">
                  <div></div>
                  <div className="flex items-center gap-4">
                    <WorkingMode 
                      workingMode={workingMode}
                      onToggle={handleWorkingModeToggle}
                    />
                    <button 
                      className="btn btn-primary"
                      onClick={() => setShowEditor(true)}
                    >
                      ‚úèÔ∏è Edit Tasks
                    </button>
                  </div>
                </div>
              </header>

              <main className="space-y-6">
                {/* All Tasks in User Input Order */}
                <div className="card">
                  <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-semibold">üìù Tasks</h2>
                    <span className="text-sm text-gray-500">
                      {tasks.filter(t => completedTasks.includes(t.id)).length}/{tasks.length} completed
                    </span>
                  </div>
                  
                  {tasks.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      No tasks configured. Click "Edit Tasks" to add some.
                    </div>
                  ) : (
                    <div className="space-y-2">
                      {tasks.map(task => (
                        <div key={task.id} className={`flex items-center justify-between p-3 border border-gray-200 rounded-lg ${isTaskCompleted(task.id) ? 'bg-green-50 opacity-60' : ''}`}>
                          <div className="flex items-center flex-1">
                            {task.type === 'timed' && (
                              <span className={`font-mono font-semibold mr-3 ${task.time === getCurrentTimeFormatted() ? 'text-red-600' : 'text-blue-600'}`}>
                                {task.time}
                              </span>
                            )}
                            <span className={isTaskCompleted(task.id) ? 'line-through' : ''}>{task.description}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            {task.type === 'timed' && task.time === getCurrentTimeFormatted() && (
                              <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-medium">
                                Now
                              </span>
                            )}
                            {isTaskCompleted(task.id) ? (
                              <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-medium">
                                ‚úì
                              </span>
                            ) : (
                              <button 
                                className="btn btn-success text-xs px-2 py-1"
                                onClick={() => handleTaskComplete(task.id)}
                              >
                                ‚úì
                              </button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </main>

              {/* Task Editor Modal */}
              {showEditor && (
                <TaskEditor 
                  tasks={tasks}
                  onSave={handleTasksSave}
                  onClose={() => setShowEditor(false)}
                />
              )}

              {/* Reminder Popup */}
              {showReminder && reminderData && (
                <ReminderPopup 
                  reminderData={reminderData}
                  onComplete={() => setShowReminder(false)}
                  onSnooze={() => setShowReminder(false)}
                  onClose={() => setShowReminder(false)}
                />
              )}
            </div>
          </div>
        );
      };

      // Render the app
      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
